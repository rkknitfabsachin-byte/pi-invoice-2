<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Proforma Invoice</title>

<style>
/* ===== GLOBAL ===== */
body{
  margin:0;
  background:linear-gradient(to bottom right,#dbeafe,#f8fafc);
  font-family:Inter,Arial;
}
.wrap{
  max-width:1000px;
  margin:20px auto;
  padding:12px;
}

/* ===== GLASS CARD ===== */
.card{
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(12px);
  padding:18px;
  border-radius:18px;
  box-shadow:0 8px 25px rgba(0,0,0,0.1);
  margin-top:18px;
}

h2{text-align:center;margin-bottom:15px;}
h3{margin-bottom:12px;}

label{
  font-size:13px;
  font-weight:600;
  margin-top:10px;
  display:block;
}

/* ===== INPUTS ===== */
input,select{
  width:100%;
  padding:10px;
  margin-top:5px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:14px;
}
input:focus{
  border-color:#2563eb;
  outline:none;
}

/* ===== GRID ===== */
.row{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
}
.row.two{grid-template-columns:repeat(2,1fr);}
@media(max-width:768px){
  .row{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:480px){
  .row{grid-template-columns:1fr;}
}

/* ===== TABLE ===== */
table{
  width:100%;
  margin-top:12px;
  border-collapse:collapse;
  border-radius:14px;
  overflow:hidden;
}
th{
  background:#e2e8f0;
  padding:10px;
  font-size:13px;
}
td{
  background:#fff;
  padding:10px;
  font-size:13px;
  text-align:center;
}

/* ===== BUTTONS ===== */
.btn{
  background:linear-gradient(to right,#2563eb,#3b82f6);
  color:white;
  padding:8px 12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:13px;
}
.btn.red{background:#dc2626;}

/* ===== SEARCHABLE DROPDOWN ===== */
.searchBoxWrapper{position:relative;}
.searchInput{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #cbd5e1;
}
.searchBoxWrapper select{display:none;}
.customDropdown{
  position:absolute;
  top:100%;
  left:0;
  right:0;
  background:white;
  border-radius:12px;
  border:1px solid #ddd;
  max-height:200px;
  overflow-y:auto;
  display:none;
  z-index:999;
}
.customDropdown div{
  padding:10px;
  cursor:pointer;
}
.customDropdown div:hover{background:#e5f0ff;}
</style>
</head>

<body>
<div class="wrap">
<h2>Proforma Invoice</h2>

<!-- PARTY -->
<div class="card">
<h3>Party Details</h3>
<label>Select Party</label>
<div class="searchBoxWrapper">
<input class="searchInput" placeholder="Search party..." oninput="filterDropdown(this,'partySelect')">
<select id="partySelect"></select>
<div class="customDropdown" data-for="partySelect"></div>
</div>

<label>Contact Number</label>
<input id="contactNumber">
</div>

<!-- PI DETAILS -->
<div class="card">
<h3>PI Details</h3>
<div class="row two">
  <div><label>PO Number</label><input id="poNumber"></div>
  <div><label>CRM</label><input id="crm"></div>
  <div><label>Priority</label><input id="priority"></div>
  <div><label>Shade Reference</label><input id="shadeRef"></div>
  <div><label>Lot Number</label><input id="lotNo"></div>
  <div><label>Delivery Date</label><input type="date" id="deliveryDate"></div>
  <div><label>Payment Terms</label><input id="paymentTerms"></div>
  <div><label>Notes</label><input id="notes"></div>
</div>
</div>

<!-- ITEMS -->
<div class="card">
<h3>Add Items</h3>

<div class="row">
  <div>
    <label>Item</label>
    <div class="searchBoxWrapper">
      <input class="searchInput" placeholder="Search item..." oninput="filterDropdown(this,'itemSelect')">
      <select id="itemSelect"></select>
      <div class="customDropdown" data-for="itemSelect"></div>
    </div>
  </div>

  <div>
    <label>Color</label>
    <div class="searchBoxWrapper">
      <input class="searchInput" placeholder="Search color..." oninput="filterDropdown(this,'itemColor')">
      <select id="itemColor"></select>
      <div class="customDropdown" data-for="itemColor"></div>
    </div>
  </div>

  <div>
    <label>GSM</label>
    <input id="itemGSM" placeholder="Enter GSM">
  </div>

  <div>
    <label>DIA</label>
    <input id="itemDIA" placeholder="Enter DIA">
  </div>
</div>

<div class="row two">
  <div><label>Qty</label><input id="itemQty" type="number"></div>
  <div><label>Rate</label><input id="itemRate" type="number"></div>
</div>

<button class="btn" onclick="addItem()">Add Item</button>

<table id="itemsTable">
<thead>
<tr>
<th>Item</th><th>Color</th><th>GSM</th><th>DIA</th>
<th>Qty</th><th>Rate</th><th>Amount</th><th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<button class="btn" onclick="generatePI()">Generate PI</button>
</div>

<script>
let MASTER={}, ITEMS=[];

async function loadMasters(){
  const url="https://script.google.com/macros/s/AKfycbxJgQOV2Ip19EpFJltnOAFaaGD1GX2iPub850ie0H4_fAF5fL35nFBcXuCC9-f0q5Lnxw/exec?action=masters";
  const r=await fetch(url);
  MASTER=await r.json();

  MASTER.parties.forEach(p=>{
    partySelect.add(new Option(p.PartyName,p.PartyID));
  });
  MASTER.items.forEach(i=>{
    itemSelect.add(new Option(i.ItemName,i.ItemID));
  });
  [...new Set(MASTER.items.map(i=>i.Color).filter(Boolean))].forEach(c=>{
    itemColor.add(new Option(c,c));
  });
  buildAllDropdownLists();
}
loadMasters();

function addItem(){
  let it=MASTER.items.find(x=>x.ItemID==itemSelect.value);
  let qty=+itemQty.value||0;
  let rate=+itemRate.value||it.Rate||0;
  ITEMS.push({
    ItemID:it.ItemID,
    ItemName:it.ItemName,
    Color:itemColor.value,
    GSM:itemGSM.value,
    DIA:itemDIA.value,
    Qty:qty,
    Rate:rate,
    Amount:qty*rate
  });
  renderItems();
}

function renderItems(){
  let tb=itemsTable.tBodies[0];
  tb.innerHTML="";
  ITEMS.forEach((r,i)=>{
    tb.insertAdjacentHTML("beforeend",
      "<tr>"+
      "<td>"+r.ItemName+"</td>"+
      "<td>"+r.Color+"</td>"+
      "<td>"+r.GSM+"</td>"+
      "<td>"+r.DIA+"</td>"+
      "<td>"+r.Qty+"</td>"+
      "<td>"+r.Rate+"</td>"+
      "<td>"+r.Amount.toFixed(2)+"</td>"+
      "<td>"+
      "<button class='btn' onclick='duplicateItem("+i+")'>D</button> "+
      "<button class='btn' onclick='editItem("+i+")'>E</button> "+
      "<button class='btn red' onclick='delItem("+i+")'>X</button>"+
      "</td></tr>");
  });
}

function delItem(i){ITEMS.splice(i,1);renderItems();}
function duplicateItem(i){ITEMS.push({...ITEMS[i]});renderItems();}
function editItem(i){
  let r=ITEMS[i];
  itemSelect.value=r.ItemID;
  itemColor.value=r.Color;
  itemGSM.value=r.GSM;
  itemDIA.value=r.DIA;
  itemQty.value=r.Qty;
  itemRate.value=r.Rate;
  ITEMS.splice(i,1);
  renderItems();
}

async function generatePI(){
  if(!ITEMS.length) return alert("Add at least one item");
  let data={
    partyId:partySelect.value,
    items:ITEMS,
    extras:{
      poNumber:poNumber.value,
      contactNumber:contactNumber.value,
      crm:crm.value,
      priority:priority.value,
      shadeRef:shadeRef.value,
      lotNo:lotNo.value,
      deliveryDate:deliveryDate.value,
      paymentTerms:paymentTerms.value,
      notes:notes.value
    }
  };
  let url="https://script.google.com/macros/s/AKfycbxJgQOV2Ip19EpFJltnOAFaaGD1GX2iPub850ie0H4_fAF5fL35nFBcXuCC9-f0q5Lnxw/exec?action=generate&data="+encodeURIComponent(JSON.stringify(data));
  let r=await fetch(url);
  let res=await r.json();
  if(res.ok) window.open(res.pdfUrl); else alert(res.error);
}

/* DROPDOWN LOGIC */
function buildAllDropdownLists(){
  document.querySelectorAll("select").forEach(sel=>{
    let list=document.querySelector(".customDropdown[data-for='"+sel.id+"']");
    list.innerHTML="";
    [...sel.options].forEach(op=>{
      let d=document.createElement("div");
      d.textContent=op.textContent;
      d.onclick=()=>{sel.value=op.value;event.target.closest(".customDropdown").style.display="none";};
      list.appendChild(d);
    });
  });
}
function filterDropdown(input,id){
  let sel=document.getElementById(id);
  let list=document.querySelector(".customDropdown[data-for='"+id+"']");
  list.innerHTML="";
  [...sel.options].forEach(op=>{
    if(op.textContent.toLowerCase().includes(input.value.toLowerCase())){
      let d=document.createElement("div");
      d.textContent=op.textContent;
      d.onclick=()=>{sel.value=op.value;input.value=op.textContent;list.style.display="none";};
      list.appendChild(d);
    }
  });
  list.style.display="block";
}
document.addEventListener("click",e=>{
  if(!e.target.classList.contains("searchInput")){
    document.querySelectorAll(".customDropdown").forEach(d=>d.style.display="none");
  }
});
</script>
</body>
</html>
