<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Proforma Invoice</title>

<style>
body{
  margin:0;
  background:linear-gradient(to bottom right,#dbeafe,#f8fafc);
  font-family:Inter,Arial;
}
.wrap{max-width:900px;margin:25px auto;padding:15px;}
.card{
  background:rgba(255,255,255,0.7);
  backdrop-filter:blur(12px);
  padding:22px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.10);
  margin-top:20px;
}
h2{text-align:center;margin-bottom:20px;}
h3{margin-bottom:15px;}
label{font-size:14px;font-weight:600;margin-top:15px;display:block;}
input,select{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid #d1d5db;
}
.row{display:flex;gap:12px;}
.col{flex:1;}
table{width:100%;margin-top:15px;border-collapse:collapse;}
th,td{padding:12px;}
th{background:#e2e8f0;}
td{background:rgba(255,255,255,0.7);}
.btn{
  background:#2563eb;
  color:white;
  padding:8px 12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
.btn.red{background:#dc2626;}

.searchBoxWrapper{position:relative;}
.searchInput{
  width:100%;
  padding:10px;
  border:1px solid #cbd5e1;
  border-radius:10px;
  margin-bottom:6px;
}
.customDropdown{
  position:absolute;
  top:100%;
  left:0;
  right:0;
  background:white;
  border-radius:12px;
  border:1px solid #ddd;
  max-height:200px;
  overflow-y:auto;
  display:none;
  z-index:999;
}
.customDropdown div{padding:10px;cursor:pointer;}
.customDropdown div:hover{background:#e5f0ff;}
</style>
</head>

<body>
<div class="wrap">
<h2>Proforma Invoice</h2>

<!-- PARTY -->
<div class="card">
<h3>Party Details</h3>
<label>Select Party</label>
<div class="searchBoxWrapper">
<input class="searchInput" placeholder="Search party..." oninput="filterDropdown(this,'partySelect')">
<select id="partySelect"></select>
<div class="customDropdown" data-for="partySelect"></div>
</div>
<label>Contact Number</label>
<input id="contactNumber">
</div>

<!-- ITEMS -->
<div class="card">
<h3>Add Items</h3>

<div class="row">
<div class="col">
<label>Item</label>
<div class="searchBoxWrapper">
<input class="searchInput" placeholder="Search item..." oninput="filterDropdown(this,'itemSelect')">
<select id="itemSelect"></select>
<div class="customDropdown" data-for="itemSelect"></div>
</div>
</div>

<div class="col">
<label>Qty</label>
<input id="itemQty" type="number">
</div>

<div class="col">
<label>Rate</label>
<input id="itemRate" type="number">
</div>
</div>

<button class="btn" onclick="addItem()">Add Item</button>

<table id="itemsTable">
<thead>
<tr>
<th>Item</th><th>Qty</th><th>Rate</th><th>Amount</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<button class="btn" onclick="generatePI()">Generate PI</button>
</div>

<script>
let MASTER = {};
let ITEMS = [];

/* ===== BACKEND LOAD (UNCHANGED) ===== */
async function loadMasters(){
  const url = "https://script.google.com/macros/s/AKfycbxJgQOV2Ip19EpFJltnOAFaaGD1GX2iPub850ie0H4_fAF5fL35nFBcXuCC9-f0q5Lnxw/exec?action=masters";
  const r = await fetch(url);
  MASTER = await r.json();

  MASTER.parties.forEach(p=>{
    let o=document.createElement("option");
    o.value=p.PartyID;o.textContent=p.PartyName;
    partySelect.appendChild(o);
  });

  MASTER.items.forEach(i=>{
    let o=document.createElement("option");
    o.value=i.ItemID;o.textContent=i.ItemName;
    itemSelect.appendChild(o);
  });

  buildAllDropdownLists();
}
loadMasters();

/* ===== ADD ITEM (UNCHANGED) ===== */
function addItem(){
  let it = MASTER.items.find(x=>x.ItemID==itemSelect.value);
  let qty = parseFloat(itemQty.value||0);
  let rate = parseFloat(itemRate.value||it.Rate||0);
  ITEMS.push({
    ItemID:it.ItemID,
    ItemName:it.ItemName,
    Qty:qty,
    Rate:rate,
    Amount:qty*rate
  });
  renderItems();
}

/* ===== RENDER (MODIFIED SAFELY) ===== */
function renderItems(){
  let tbody=document.querySelector("#itemsTable tbody");
  tbody.innerHTML="";
  ITEMS.forEach((r,i)=>{
    let tr=document.createElement("tr");
    tr.innerHTML =
      "<td>"+r.ItemName+"</td>"+
      "<td>"+r.Qty+"</td>"+
      "<td>"+r.Rate+"</td>"+
      "<td>"+r.Amount.toFixed(2)+"</td>"+
      "<td>"+
        "<button class='btn' onclick='duplicateItem("+i+")'>D</button> "+
        "<button class='btn' onclick='editItem("+i+")'>E</button> "+
        "<button class='btn red' onclick='delItem("+i+")'>X</button>"+
      "</td>";
    tbody.appendChild(tr);
  });
}

/* ===== ORIGINAL DELETE ===== */
function delItem(i){ ITEMS.splice(i,1); renderItems(); }

/* ===== NEW: DUPLICATE ===== */
function duplicateItem(i){
  ITEMS.push(JSON.parse(JSON.stringify(ITEMS[i])));
  renderItems();
}

/* ===== NEW: EDIT ===== */
function editItem(i){
  let r = ITEMS[i];
  itemSelect.value = r.ItemID;
  itemQty.value = r.Qty;
  itemRate.value = r.Rate;
  ITEMS.splice(i,1);
  renderItems();
}

/* ===== BACKEND GENERATE (UNCHANGED) ===== */
async function generatePI(){
  if(ITEMS.length==0) return alert("Add at least one item");

  let data = {
    partyId: partySelect.value,
    items: ITEMS,
    extras: { contactNumber: contactNumber.value }
  };

  let url = "https://script.google.com/macros/s/AKfycbxJgQOV2Ip19EpFJltnOAFaaGD1GX2iPub850ie0H4_fAF5fL35nFBcXuCC9-f0q5Lnxw/exec?action=generate&data="
            + encodeURIComponent(JSON.stringify(data));
  let r = await fetch(url);
  let res = await r.json();

  if(res.ok) window.open(res.pdfUrl);
  else alert(res.error);
}

/* ===== DROPDOWN LOGIC (UNCHANGED) ===== */
function buildAllDropdownLists(){
  document.querySelectorAll("select").forEach(sel=>{
    let list=document.querySelector(".customDropdown[data-for='"+sel.id+"']");
    list.innerHTML="";
    [...sel.options].forEach(op=>{
      let d=document.createElement("div");
      d.textContent=op.textContent;
      d.onclick=function(){sel.value=op.value;list.style.display="none";};
      list.appendChild(d);
    });
  });
}

function filterDropdown(input,id){
  let sel=document.getElementById(id);
  let list=document.querySelector(".customDropdown[data-for='"+id+"']");
  list.innerHTML="";
  [...sel.options].forEach(op=>{
    if(op.textContent.toLowerCase().includes(input.value.toLowerCase())){
      let d=document.createElement("div");
      d.textContent=op.textContent;
      d.onclick=function(){
        sel.value=op.value;
        input.value=op.textContent;
        list.style.display="none";
      };
      list.appendChild(d);
    }
  });
  list.style.display="block";
}

document.addEventListener("click",e=>{
  if(!e.target.classList.contains("searchInput")){
    document.querySelectorAll(".customDropdown").forEach(d=>d.style.display="none");
  }
});
</script>
</body>
</html>
