<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Proforma Invoice</title>

<style>
/* ===== GLOBAL ===== */
body{
  margin:0;
  background:linear-gradient(to bottom right,#dbeafe,#f8fafc);
  font-family:Inter,Arial;
  animation:fadeIn .6s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:none;}}

.wrap{
  max-width:900px;
  margin:25px auto;
  padding:15px;
}

/* ===== GLASS CARD ===== */
.card{
  background:rgba(255,255,255,0.7);
  backdrop-filter:blur(12px);
  padding:22px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.10);
  margin-top:20px;
  transition:.3s;
}
.card:hover{
  transform:translateY(-3px);
  box-shadow:0 15px 35px rgba(0,0,0,0.15);
}

h2{
  font-size:26px;
  font-weight:700;
  text-align:center;
  margin-bottom:20px;
}
h3{
  font-size:18px;
  margin-bottom:15px;
}

label{
  font-size:14px;
  font-weight:600;
  margin-top:15px;
  display:block;
}

/* ===== INPUTS ===== */
input,select{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid #d1d5db;
  background:rgba(255,255,255,0.8);
  transition:.2s;
}
input:focus,select:focus{
  border-color:#3b82f6;
  outline:none;
  background:white;
}

/* ===== ROW FLEX ===== */
.row{
  display:flex;
  gap:12px;
}
.col{flex:1;}

/* ===== TABLE ===== */
table{
  width:100%;
  margin-top:15px;
  border-collapse:collapse;
  backdrop-filter:blur(12px);
  overflow:hidden;
  border-radius:15px;
}
th{
  background:#e2e8f0;
  padding:12px;
  font-size:14px;
}
td{
  background:rgba(255,255,255,0.7);
  padding:12px;
}
tr:hover td{
  background:#f1f5f9;
}

/* ===== BUTTONS ===== */
.btn{
  background:linear-gradient(to right,#2563eb,#4780ff);
  color:white;
  padding:12px 18px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  margin-top:15px;
  font-size:15px;
  font-weight:600;
  box-shadow:0 6px 15px rgba(37,99,235,0.35);
  transition:.25s;
}
.btn:hover{
  transform:translateY(-3px);
  box-shadow:0 10px 20px rgba(37,99,235,0.45);
}
.btn.red{
  background:#dc2626;
  box-shadow:0 6px 15px rgba(220,38,38,0.35);
}

/* ======= SEARCHABLE DROPDOWN COMPONENT ======= */
.searchBoxWrapper{
  position:relative;
}

.searchInput{
  width:100%;
  padding:10px;
  border:1px solid #cbd5e1;
  border-radius:10px;
  margin-bottom:8px;
}

.customDropdown{
  position:absolute;
  top:100%;
  left:0;
  right:0;
  background:white;
  border-radius:12px;
  border:1px solid #ddd;
  max-height:220px;
  overflow-y:auto;
  display:none;
  z-index:999;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
}

.customDropdown div{
  padding:10px;
  cursor:pointer;
}
.customDropdown div:hover{
  background:#e5f0ff;
}
</style>
</head>

<body>
<div class="wrap">
  <h2>Proforma Invoice</h2>

  <!-- PARTY -->
  <div class="card">
    <h3>Party Details</h3>

    <label>Select Party</label>
    <div class="searchBoxWrapper">
      <input class="searchInput" placeholder="Search party..." oninput="filterDropdown(this,'partySelect')">
      <select id="partySelect"></select>
      <div class="customDropdown" data-for="partySelect"></div>
    </div>

    <label>Contact Number</label>
    <input id="contactNumber" placeholder="Enter mobile number">
  </div>

  <!-- PI DETAILS -->
  <div class="card">
    <h3>PI Details</h3>

    <label>PO Number</label>
    <input id="poNumber">

    <label>CRM</label>
    <input id="crm">

    <label>Priority</label>
    <input id="priority">

    <label>Shade Reference</label>
    <input id="shadeRef">

    <label>Lot Number</label>
    <input id="lotNo">

    <label>Delivery Date</label>
    <input type="date" id="deliveryDate">

    <label>Payment Terms</label>
    <input id="paymentTerms">

    <label>Notes</label>
    <input id="notes">
  </div>

  <!-- ITEMS -->
  <div class="card">
    <h3>Add Items</h3>

    <div class="row">
      <div class="col">
        <label>Item</label>
        <div class="searchBoxWrapper">
          <input class="searchInput" placeholder="Search item..." oninput="filterDropdown(this,'itemSelect')">
          <select id="itemSelect"></select>
          <div class="customDropdown" data-for="itemSelect"></div>
        </div>
      </div>

      <div class="col">
        <label>Color</label>
        <div class="searchBoxWrapper">
          <input class="searchInput" placeholder="Search color..." oninput="filterDropdown(this,'itemColor')">
          <select id="itemColor"></select>
          <div class="customDropdown" data-for="itemColor"></div>
        </div>
      </div>

      <div class="col">
        <label>GSM</label>
        <div class="searchBoxWrapper">
          <input class="searchInput" placeholder="Search GSM..." oninput="filterDropdown(this,'itemGSM')">
          <select id="itemGSM"></select>
          <div class="customDropdown" data-for="itemGSM"></div>
        </div>
      </div>

      <div class="col">
        <label>DIA</label>
        <div class="searchBoxWrapper">
          <input class="searchInput" placeholder="Search DIA..." oninput="filterDropdown(this,'itemDIA')">
          <select id="itemDIA"></select>
          <div class="customDropdown" data-for="itemDIA"></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Qty</label>
        <input id="itemQty" type="number" step="0.01">
      </div>
      <div class="col">
        <label>Rate</label>
        <input id="itemRate" type="number" step="0.01">
      </div>
    </div>

    <button class="btn" onclick="addItem()">Add Item</button>

    <table id="itemsTable">
      <thead>
        <tr>
          <th>Item</th><th>Color</th><th>GSM</th><th>DIA</th><th>Qty</th><th>Rate</th><th>Amount</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button class="btn" onclick="generatePI()">Generate PI</button>
</div>

<script>
let MASTER = {};
let ITEMS = [];

async function loadMasters(){
  const url = "https://script.google.com/macros/s/AKfycbxJgQOV2Ip19EpFJltnOAFaaGD1GX2iPub850ie0H4_fAF5fL35nFBcXuCC9-f0q5Lnxw/exec?action=masters";
  const r = await fetch(url);
  MASTER = await r.json();

  let pSel = document.getElementById("partySelect");
  MASTER.parties.forEach(p=>{
    let opt = document.createElement("option");
    opt.value = p.PartyID;
    opt.textContent = p.PartyName;
    pSel.appendChild(opt);
  });

  let iSel = document.getElementById("itemSelect");
  MASTER.items.forEach(it=>{
    let o=document.createElement("option");
    o.value=it.ItemID; o.textContent=it.ItemName;
    iSel.appendChild(o);
  });

  fillDropdown("itemColor", MASTER.items.map(i=>i.Color).filter(x=>x));
  fillDropdown("itemGSM", MASTER.items.map(i=>i.GSM).filter(x=>x));
  fillDropdown("itemDIA", MASTER.items.map(i=>i.DIA).filter(x=>x));

  buildAllDropdownLists();
}

function fillDropdown(id, arr){
  let setArr = [...new Set(arr)];
  let sel = document.getElementById(id);
  setArr.forEach(v=>{
    let o=document.createElement("option"); o.value=v; o.textContent=v;
    sel.appendChild(o);
  });
}

function addItem(){
  let itemID = document.getElementById("itemSelect").value;
  let it = MASTER.items.find(x=>x.ItemID==itemID);

  let color=document.getElementById("itemColor").value;
  let gsm=document.getElementById("itemGSM").value;
  let dia=document.getElementById("itemDIA").value;
  let qty=parseFloat(document.getElementById("itemQty").value||0);
  let rate=parseFloat(document.getElementById("itemRate").value||it.Rate||0);
  let amount=qty*rate;

  ITEMS.push({ItemID:itemID,ItemName:it.ItemName,Color:color,GSM:gsm,DIA:dia,Qty:qty,Rate:rate,Amount:amount});
  renderItems();
}

function renderItems(){
  let tbody=document.querySelector("#itemsTable tbody");
  tbody.innerHTML="";
  ITEMS.forEach((r,i)=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.ItemName}</td>
      <td>${r.Color}</td>
      <td>${r.GSM}</td>
      <td>${r.DIA}</td>
      <td>${r.Qty}</td>
      <td>${r.Rate}</td>
      <td>${r.Amount.toFixed(2)}</td>
      <td>
        <button class='btn' onclick='duplicateItem(${i})'>D</button>
        <button class='btn' onclick='editItem(${i})'>E</button>
        <button class='btn red' onclick='delItem(${i})'>X</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function delItem(i){ ITEMS.splice(i,1); renderItems(); }

function duplicateItem(i){
  const copy = JSON.parse(JSON.stringify(ITEMS[i]));
  ITEMS.push(copy);
  renderItems();
}

function editItem(i){
  const r = ITEMS[i];
  document.getElementById("itemSelect").value = r.ItemID;
  document.getElementById("itemColor").value = r.Color;
  document.getElementById("itemGSM").value = r.GSM;
  document.getElementById("itemDIA").value = r.DIA;
  document.getElementById("itemQty").value = r.Qty;
  document.getElementById("itemRate").value = r.Rate;

  ITEMS.splice(i,1);
  renderItems();
} renderItems(); }

async function generatePI(){
  if(ITEMS.length==0) return alert("Add at least one item");

  let data = {
    partyId: document.getElementById("partySelect").value,
    items: ITEMS,
    extras: {
      poNumber: document.getElementById("poNumber").value,
      contactNumber: document.getElementById("contactNumber").value,
      crm: document.getElementById("crm").value,
      priority: document.getElementById("priority").value,
      shadeRef: document.getElementById("shadeRef").value,
      lotNo: document.getElementById("lotNo").value,
      deliveryDate: document.getElementById("deliveryDate").value,
      paymentTerms: document.getElementById("paymentTerms").value,
      notes: document.getElementById("notes").value
    }
  };

  let url = "https://script.google.com/macros/s/AKfycbxJgQOV2Ip19EpFJltnOAFaaGD1GX2iPub850ie0H4_fAF5fL35nFBcXuCC9-f0q5Lnxw/exec?action=generate&data="+encodeURIComponent(JSON.stringify(data));
  let r = await fetch(url);
  let res = await r.json();

  if(res.ok){
    window.open(res.pdfUrl); 
  } else alert(res.error);
}

loadMasters();

function buildAllDropdownLists(){
  document.querySelectorAll("select").forEach(sel=>{
    let list = document.querySelector(`.customDropdown[data-for='${sel.id}']`);
    list.innerHTML="";
    [...sel.options].forEach(op=>{
      let div=document.createElement("div");
      div.textContent=op.textContent;
      div.onclick=()=>{
        sel.value=op.value;
        list.style.display="none";
      };
      list.appendChild(div);
    });
  });
}

function filterDropdown(input, selectId){
  let list = document.querySelector(`.customDropdown[data-for='${selectId}']`);
  let sel = document.getElementById(selectId);

  list.innerHTML="";
  let val = input.value.toLowerCase();

  [...sel.options].forEach(op=>{
    if(op.textContent.toLowerCase().includes(val)){
      let div=document.createElement("div");
      div.textContent=op.textContent;
      div.onclick=()=>{
        sel.value=op.value;
        list.style.display="none";
      };
      list.appendChild(div);
    }
  });

  list.style.display="block";
}

document.addEventListener("click",e=>{
  if(!e.target.classList.contains("searchInput")){
    document.querySelectorAll(".customDropdown").forEach(d=>d.style.display="none");
  }
});
</script>

</body>
</html>
